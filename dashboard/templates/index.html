<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SISMONICAMARAS Dashboard</title>

  <!-- ‚úÖ Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

  <link rel="stylesheet" href="/static/style.css">
  <script>
    // üëá Mapea ingl√©s -> espa√±ol
    function traducirEstado(estado) {
      switch (estado.toLowerCase()) {
        case "online": return "En l√≠nea";
        case "offline": return "Fuera de l√≠nea";
        case "reconnecting": return "Reconectando...";
        default: return estado;
      }
    }

    function actualizarEstadoCamera(estado) {
      const cameraStatus = document.getElementById("cameraStatus");

      // ‚úÖ Texto en espa√±ol
      cameraStatus.textContent = traducirEstado(estado);

      // ‚úÖ Clases (sem√°foro)
      cameraStatus.className = "";
      if (estado.toLowerCase() === "online") cameraStatus.classList.add("status-online");
      if (estado.toLowerCase() === "offline") cameraStatus.classList.add("status-offline");
      if (estado.toLowerCase() === "reconnecting") cameraStatus.classList.add("status-reconnecting");
    }

    async function updateStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json();

        // Actualizar contadores
        document.getElementById("inside").innerText = data.inside ?? data.state?.inside ?? 0;
        document.getElementById("entered").innerText = data.entered ?? data.state?.entered ?? 0;
        document.getElementById("exited").innerText = data.exited ?? data.state?.exited ?? 0;

        // üö¶ Estado de la c√°mara
        actualizarEstadoCamera(data.camera_status ?? "offline");

        // Encender/apagar feed de video
        const videoFeed = document.getElementById("videoFeed");
        if (data.camera_active && videoFeed.src === "") {
          videoFeed.src = "/video";
        }
        if (!data.camera_active && videoFeed.src !== "") {
          videoFeed.src = "";
        }
      } catch (e) {
        console.error("‚ùå Error obteniendo estado:", e);
      }
    }

    async function toggleCamera() {
      try {
        const res = await fetch("/toggle_camera", { method: "POST" });
        const data = await res.json();

        // üö¶ Estado de la c√°mara
        actualizarEstadoCamera(data.camera_status ?? "offline");

        const videoFeed = document.getElementById("videoFeed");
        if (data.camera_active) {
          videoFeed.src = "/video";
        } else {
          videoFeed.src = "";
        }
      } catch (e) {
        console.error("‚ùå Error alternando c√°mara:", e);
      }
    }

    async function updateDurations() {
      try {
        const res = await fetch("/durations");
        const data = await res.json();
        let html = "";
        for (const [id, seconds] of Object.entries(data)) {
          html += `<p>Persona ${id}: ${Math.round(seconds)} segundos</p>`;
        }
        document.getElementById("durations").innerHTML = html;
      } catch (e) {
        console.error("‚ùå Error obteniendo tiempos de permanencia:", e);
      }
    }

    setInterval(updateStatus, 2000);
    setInterval(updateDurations, 5000);
    window.onload = function() {
      updateStatus();
      updateDurations();
    }
  </script>
</head>
<body>
  <!-- Encabezado -->
  <header>
    <h1>HI - TECH PEOPLE SAS</h1>
    <h2>Sistema de Monitoreo de C√°maras</h2>
  </header>

    <!-- Controles de la c√°mara -->
  <section class="camera-control">
    <h3>üì∑ C√°mara en Tiempo Real</h3>
    <button id="toggleCameraBtn" onclick="toggleCamera()">
      <svg xmlns="http://www.w3.org/2000/svg" 
          width="16" height="16" 
          fill="currentColor" 
          viewBox="0 0 16 16"
          style="vertical-align: middle; margin-right: 5px;">
        <path d="M10.5 3a.5.5 0 0 1 .5.5v1.528l2.528-1.264A.5.5 0 0 1 14 4.236v7.528a.5.5 0 0 1-.472.472L11 11.472V13.5a.5.5 0 0 1-.5.5h-9A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h9z"/>
      </svg>
      Video en vivo
    </button>
    <div>
  <img id="videoFeed" 
       src="" 
       alt="Transmisi√≥n de v√≠deo"
       onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;64&quot; height=&quot;64&quot; fill=&quot;%23aaa&quot; viewBox=&quot;0 0 16 16&quot;><path d=&quot;M6.5 3.5A1.5 1.5 0 0 0 5 5v6a1.5 1.5 0 0 0 1.5 1.5h4a1.5 1.5 0 0 0 1.5-1.5V9.972l2.528 1.264A.5.5 0 0 0 15 10.736V5.264a.5.5 0 0 0-.472-.472L12 6.028V5A1.5 1.5 0 0 0 10.5 3.5z&quot;/></svg>';">
</div>
  </section>

  <!-- Estado -->
  <section class="status">
    <h3>üìä Estado Actual</h3>
    <p><strong>Personas dentro:</strong> <span id="inside">0</span></p>
    <p><strong>Total Entradas:</strong> <span id="entered">0</span></p>
    <p><strong>Total Salidas:</strong> <span id="exited">0</span></p>

    <!-- üö¶ Estado de la c√°mara con colores -->
    <p>
      <strong>Estado de C√°mara:</strong>
      <span id="cameraStatus" class="status-offline">Fuera de l√≠nea</span>
    </p>
  </section>

  <!-- Tiempos de permanencia -->
  <section class="durations">
    <h3>‚è±Ô∏è Tiempos de Permanencia</h3>
    <div id="durations"></div>
  </section>

  <!-- Reportes -->
  <section class="reports">
    <h3>üìë Reportes</h3>
    <button onclick="window.location.href='/reports/daily'">Reporte Diario</button>
    <button onclick="window.location.href='/reports/weekly'">Reporte Semanal</button>
    <button onclick="window.location.href='/reports/monthly'">Reporte Mensual</button>
  </section>
</body>
</html>