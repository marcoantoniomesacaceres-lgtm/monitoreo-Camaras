<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SISMONICAMARAS Dashboard</title>

  <!-- ‚úÖ Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">

  <link rel="stylesheet" href="/static/style.css">
  <script>
    async function updateStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json();

        // Actualizar contadores
        document.getElementById("inside").innerText = data.inside ?? data.state?.inside ?? 0;
        document.getElementById("entered").innerText = data.entered ?? data.state?.entered ?? 0;
        document.getElementById("exited").innerText = data.exited ?? data.state?.exited ?? 0;

        // üö¶ Actualizar estado de la c√°mara con clases (sem√°foro)
        const cameraStatus = document.getElementById("cameraStatus");
        if (data.camera_status === "ONLINE") {
          cameraStatus.innerText = "ONLINE";
          cameraStatus.className = "status-online";
        } else if (data.camera_status === "RECONNECTING") {
          cameraStatus.innerText = "RECONNECTING...";
          cameraStatus.className = "status-reconnecting";
        } else {
          cameraStatus.innerText = "OFFLINE";
          cameraStatus.className = "status-offline";
        }

        // Encender/apagar feed de video
        const videoFeed = document.getElementById("videoFeed");
        if (data.camera_active && videoFeed.src === "") {
          videoFeed.src = "/video";
        }
        if (!data.camera_active && videoFeed.src !== "") {
          videoFeed.src = "";
        }
      } catch (e) {
        console.error("‚ùå Error obteniendo estado:", e);
      }
    }

    async function toggleCamera() {
      try {
        const res = await fetch("/toggle_camera", { method: "POST" });
        const data = await res.json();

        const cameraStatus = document.getElementById("cameraStatus");
        if (data.camera_status === "ONLINE") {
          cameraStatus.innerText = "ONLINE";
          cameraStatus.className = "status-online";
        } else if (data.camera_status === "RECONNECTING") {
          cameraStatus.innerText = "RECONNECTING...";
          cameraStatus.className = "status-reconnecting";
        } else {
          cameraStatus.innerText = "OFFLINE";
          cameraStatus.className = "status-offline";
        }

        const videoFeed = document.getElementById("videoFeed");
        if (data.camera_active) {
          videoFeed.src = "/video";
        } else {
          videoFeed.src = "";
        }
      } catch (e) {
        console.error("‚ùå Error alternando c√°mara:", e);
      }
    }

    async function updateDurations() {
      try {
        const res = await fetch("/durations");
        const data = await res.json();
        let html = "";
        for (const [id, seconds] of Object.entries(data)) {
          html += `<p>Persona ${id}: ${Math.round(seconds)} segundos</p>`;
        }
        document.getElementById("durations").innerHTML = html;
      } catch (e) {
        console.error("‚ùå Error obteniendo tiempos de permanencia:", e);
      }
    }

    setInterval(updateStatus, 2000);
    setInterval(updateDurations, 5000);
    window.onload = function() {
      updateStatus();
      updateDurations();
    }
  </script>
</head>
<body>
  <!-- Encabezado -->
  <header>
    <h1>HI - TECH PEOPLE SAS</h1>
    <h2>Sistema de Monitoreo de C√°maras</h2>
  </header>

  <!-- Controles de la c√°mara -->
  <section class="camera-control">
    <h3>üì∑ C√°mara en Tiempo Real</h3>
    <button onclick="toggleCamera()">Encender/Apagar C√°mara</button>
    <div>
      <img id="videoFeed" src="" alt="Video en vivo"/>
    </div>
  </section>

  <!-- Estado -->
  <section class="status">
    <h3>üìä Estado Actual</h3>
    <p><strong>Personas dentro:</strong> <span id="inside">0</span></p>
    <p><strong>Total Entradas:</strong> <span id="entered">0</span></p>
    <p><strong>Total Salidas:</strong> <span id="exited">0</span></p>

    <!-- üö¶ Estado de la c√°mara con colores -->
    <p>
      <strong>Estado de C√°mara:</strong>
      <span id="cameraStatus" class="status-offline">OFFLINE</span>
    </p>
  </section>

  <!-- Tiempos de permanencia -->
  <section class="durations">
    <h3>‚è±Ô∏è Tiempos de Permanencia</h3>
    <div id="durations"></div>
  </section>

  <!-- Reportes -->
  <section class="reports">
    <h3>üìë Reportes</h3>
    <button onclick="window.location.href='/reports/daily'">Reporte Diario</button>
    <button onclick="window.location.href='/reports/weekly'">Reporte Semanal</button>
    <button onclick="window.location.href='/reports/monthly'">Reporte Mensual</button>
  </section>
</body>
</html>